<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>moonlight - admin</title>

<link rel="icon" href="/branding/favicon.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="/js/chip.js" ></script></script>
<style>
  :root{
    --bg-1:#000;
    --glass-bg: rgba(255,255,255,0.04);
    --glass-border: rgba(255,255,255,0.12);
    --muted: rgba(255,255,255,0.7);
    --accent: rgba(255,255,255,0.14);
    --danger:#ff4a4a;
    --ok: #4aff8a;
    --card-radius:18px;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:"Inter Tight",system-ui,Segoe UI,Roboto,Arial;}
  html,body{height:100%}
  body{
    min-height:100vh; display:flex; align-items:flex-start; justify-content:center;
    background: linear-gradient(135deg,var(--bg-1), #141414 45%, var(--bg-1)); color:#fff;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; padding:28px;
  }

  .wrap{ width:100%; max-width:1200px; display:grid; grid-template-columns: 1fr 420px; gap:20px; align-items:start; }

  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid var(--glass-border);
    border-radius:var(--card-radius);
    padding:20px;
    backdrop-filter: blur(28px);
    box-shadow: 0 18px 60px rgba(0,0,0,0.6);
    overflow: hidden;
  }

  .panel h1 { font-size:20px; margin-bottom:8px; display:flex; align-items:center; gap:10px; }
  .sub { color:var(--muted); font-size:13px; margin-bottom:14px; }

  /* UNIVERSAL INPUT STYLING - HIGHEST PRIORITY */
  input[type="text"],
  input[type="email"],
  input[type="url"],
  input[type="datetime-local"],
  input[type="search"],
  textarea,
  select {
    width: 100% !important;
    display: block !important;
    background: var(--glass-bg) !important;
    border: 1px solid rgba(255,255,255,0.12) !important;
    padding: 10px 12px !important;
    border-radius: 10px !important;
    color: #fff !important;
    outline: none !important;
    transition: all .14s ease !important;
    box-sizing: border-box !important;
    font-size: 14px !important;
    font-family: inherit !important;
    min-height: 36px !important;
  }

  input[type="text"]:focus,
  input[type="email"]:focus,
  input[type="url"]:focus,
  input[type="datetime-local"]:focus,
  input[type="search"]:focus,
  textarea:focus,
  select:focus {
    background: rgba(255,255,255,0.08) !important;
    border-color: rgba(255,255,255,0.24) !important;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.05) !important;
    transform: none !important;
  }

  textarea {
    min-height: 86px !important;
    resize: vertical !important;
  }

  input[type="text"]::placeholder,
  input[type="email"]::placeholder,
  input[type="url"]::placeholder,
  input[type="datetime-local"]::placeholder,
  input[type="search"]::placeholder,
  textarea::placeholder {
    color: rgba(255,255,255,0.4) !important;
  }

  select {
    cursor: pointer !important;
    appearance: none !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 10px center !important;
    padding-right: 32px !important;
  }

  select option {
    background: #000 !important;
    color: #fff !important;
    padding: 8px !important;
  }

  /* Checkbox styling */
  input[type="checkbox"] {
    width: auto !important;
    min-height: auto !important;
    cursor: pointer !important;
    accent-color: rgba(255,255,255,0.8) !important;
  }

  /* form */
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .field { display:flex; flex-direction:column; gap:6px; }
  
  label { 
    font-size:13px; 
    color:var(--muted); 
    display: block !important;
    margin-bottom: 4px !important;
  }

  .actions { display:flex; gap:10px; margin-top:12px; }
  button { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
  .btn-primary { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.08)); color:#fff; }
  .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
  .btn-danger { background: linear-gradient(90deg, rgba(255,74,74,0.14), rgba(255,74,74,0.08)); color:#fff; }

  /* lists */
  .list { margin-top:14px; display:flex; flex-direction:column; gap:12px; max-height:60vh; overflow:auto; padding-right:6px; }
  .card {
    background: rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.03);
    padding:12px; border-radius:12px; display:flex; gap:12px; align-items:flex-start;
    transition: transform .16s, box-shadow .16s;
  }
  .card:hover { transform: translateY(-6px); box-shadow: 0 12px 40px rgba(0,0,0,0.6); }

  .game-thumb { width:84px; height:84px; border-radius:10px; overflow:hidden; flex-shrink:0; background:#111; display:flex; align-items:center; justify-content:center; }
  .game-thumb img { width:100%; height:100%; object-fit:cover; display:block; }

  .card-body { flex:1; min-width:0; }
  .row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .title { font-weight:600; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .muted { color:var(--muted); font-size:13px; }
  .chips { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .chip { font-size:13px; padding:6px 8px; border-radius:999px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); display:inline-flex; gap:8px; align-items:center; }

  /* profiles side */
  .side { display:flex; flex-direction:column; gap:12px; }
  .profile-line { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background: rgba(255,255,255,0.01); }
  .pf-left { display:flex; gap:10px; align-items:center; min-width:0; }
  .pf-thumb { width:56px; height:56px; border-radius:10px; overflow:hidden; background:#111; display:flex; align-items:center; justify-content:center; }
  .pf-thumb img{ width:100%; height:100%; object-fit:cover; }
  .pf-meta { min-width:0; overflow:hidden; }
  .pf-meta .name { font-weight:600; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .pf-meta .email { color:var(--muted); font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* small helpers */
  .small { font-size:13px; color:var(--muted); }
  .flex { display:flex; gap:8px; align-items:center; }

  /* modal */
  .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.7); z-index:9999; }
  .modal { width:520px; background: rgba(255,255,255,0.03); border-radius:16px; padding:18px; border:1px solid rgba(255,255,255,0.08); max-height: 90vh; overflow-y: auto; }
  .modal h3{ margin-bottom:8px; }
  .modal .field { margin-bottom: 12px; }

  /* loader skeleton */
  .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.06), rgba(255,255,255,0.02)); background-size: 300% 100%; animation: shimmer 1.6s linear infinite; border-radius:8px; }
  @keyframes shimmer { 0%{ background-position:0% 50% } 100%{ background-position:100% 50% } }

  /* tabs */
  .tab-btn { background: transparent; border: 1px solid rgba(255,255,255,0.06); color: var(--muted); padding: 8px 14px; border-radius: 8px; cursor: pointer; transition: all .2s; font-size: 13px; }
  .tab-btn:hover { background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.12); }
  .tab-btn.active { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.16); color: #fff; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* responsive */
  @media (max-width:1100px){ .wrap { grid-template-columns: 1fr; } .side { order: 2; } }
</style>
</head>
<body>

<div class="wrap">

  <div class="panel" style="grid-column: 1 / -1; margin-bottom: 12px;">
    <div style="display: flex; gap: 8px; border-bottom: 1px solid rgba(255,255,255,0.04); padding-bottom: 12px;">
      <button id="tabGames" class="tab-btn active"><i class="fa-solid fa-gamepad"></i> Games</button>
      <button id="tabProfiles" class="tab-btn"><i class="fa-solid fa-users"></i> Profiles</button>
      <button id="tabAdmins" class="tab-btn"><i class="fa-solid fa-crown"></i> Admins</button>
      <button id="tabBans" class="tab-btn"><i class="fa-solid fa-ban"></i> Bans</button>
      <button id="tabSettings" class="tab-btn"><i class="fa-solid fa-gear"></i> Settings</button>
    </div>
  </div>

  <div class="panel" id="mainPanel">
    <h1><i class="fa-solid fa-shield-halved"></i> Moonlight Admin</h1>
    <div class="sub">Manage games and user profiles. All actions are applied to Supabase immediately.</div>

    <div id="gamesTab" class="tab-content active">
      
    <div id="gameForm" style="margin-bottom:12px;">
      <div class="grid">
        <div class="field">
          <label>Game Name</label>
          <input id="gameName" type="text" placeholder="Enter game name">
        </div>

        <div class="field">
          <label>Game URL (External Link)</label>
          <input id="gameExternalUrl" type="url" placeholder="https://example.com/game.html">
        </div>

        <div class="field">
          <label>Upload Game Image</label>
          <input id="gameImgUpload" type="file" accept="image/*">
          <div id="imagePreview" style="margin-top:8px; display:none;">
            <img id="previewImg" style="max-width:100px; max-height:100px; border-radius:8px;" />
          </div>
        </div>

        <div class="field">
          <label>Tags (comma separated)</label>
          <div style="display:flex; gap:8px; align-items:flex-end;">
            <input id="gameTags" type="text" placeholder="racing,fun,2d" style="flex:1;">
            <button type="button" id="generateTagsBtn" class="btn btn-ghost" title="Generate tags with AI"><i class="fa-solid fa-wand-magic-sparkles"></i> Tags</button>
          </div>
        </div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>HTML Content (for direct embed)</label>
        <textarea id="gameHtmlContent" placeholder="Paste full HTML content here..."></textarea>
        <div class="small" style="margin-top:4px;">* If this is filled, Game URL will be ignored. Content will be compressed before saving.</div>
      </div>

      <div class="field" style="margin-top:12px; display:none;"> <label>Description</label>
        <div style="display:flex; gap:8px; align-items:flex-start;">
          <textarea id="gameDesc" placeholder="Short description (up to 300 chars)" style="flex:1;"></textarea>
          <button type="button" id="generateDescBtn" class="btn btn-ghost" title="Generate description with AI" style="align-self:center;"><i class="fa-solid fa-wand-magic-sparkles"></i> Fill</button>
        </div>
      </div>

      <div class="actions">
        <button id="addGameBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Add Game</button>
        <button id="refreshGames" class="btn btn-ghost"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
        <div id="gameFormMsg" class="small" style="align-self:center; margin-left:8px;"></div>
      </div>
    </div>

    <hr style="border:0;border-top:1px solid rgba(255,255,255,0.04); margin:12px 0;">

    <h3 style="margin-bottom:8px;">Games</h3>
    <div id="gamesList" class="list">
      <div class="card skeleton" style="height:96px; border-radius:12px;"></div>
      <div class="card skeleton" style="height:96px; border-radius:12px;"></div>
      <div class="card skeleton" style="height:96px; border-radius:12px;"></div>
    </div>
    </div>

    <div id="profilesTab" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 style="margin:0 0 4px 0;">Profiles</h3>
        <div class="small">View and edit user profiles</div>
      </div>
      <div>
        <button id="refreshProfiles" class="btn btn-ghost"><i class="fa-solid fa-arrows-rotate"></i></button>
      </div>
    </div>

    <div id="profilesList" style="display:flex; flex-direction:column; gap:10px; max-height:62vh; overflow:auto; padding-top:8px;">
      <div class="profile-line skeleton" style="height:72px;"></div>
      <div class="profile-line skeleton" style="height:72px;"></div>
      <div class="profile-line skeleton" style="height:72px;"></div>
    </div>
    </div>

    <div id="adminsTab" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 style="margin:0 0 4px 0;">Admin Users</h3>
        <div class="small">Manage who can access this admin panel</div>
      </div>
      <div>
        <button id="refreshAdmins" class="btn btn-ghost"><i class="fa-solid fa-arrows-rotate"></i></button>
      </div>
    </div>

    <div style="margin-bottom: 12px;">
      <div style="display:flex; flex-direction:column; gap:6px;">
        <label style="font-size:13px; color:var(--muted);">Email to add as admin</label>
        <div style="display:flex; gap:8px;">
          <input id="adminEmailInput" type="email" placeholder="Enter email to add as admin" style="flex:1;">
          <button id="addAdminBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Add Admin</button>
        </div>
      </div>
      <div id="adminMsg" class="small" style="margin-top:8px;"></div>
    </div>

    <div id="adminsList" style="display:flex; flex-direction:column; gap:10px; max-height:62vh; overflow:auto; padding-top:8px;">
      <div class="profile-line skeleton" style="height:72px;"></div>
      <div class="profile-line skeleton" style="height:72px;"></div>
    </div>
    </div>

    <div id="bansTab" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 style="margin:0 0 4px 0;">User Bans</h3>
        <div class="small">Manage banned users and appeals</div>
      </div>
      <div>
        <button id="refreshBans" class="btn btn-ghost"><i class="fa-solid fa-arrows-rotate"></i></button>
      </div>
    </div>

    <div style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.04);">
      <div style="display:flex; flex-direction:column; gap:6px;">
        <label style="font-size:13px; color:var(--muted);">Search username to create ban</label>
        <div style="display:flex; gap:8px;">
          <input id="banSearchUsername" type="text" placeholder="Search by username..." style="flex:1;">
          <button id="searchUserBtn" class="btn btn-primary"><i class="fa-solid fa-search"></i></button>
        </div>
        <div id="searchResult" style="font-size:12px; color:var(--muted); margin-top:6px;"></div>
        <button id="createBanBtn" class="btn btn-danger" style="margin-top:6px; display:none;"><i class="fa-solid fa-gavel"></i> Create Ban</button>
      </div>
      <div id="banMsg" class="small" style="margin-top:8px;"></div>
    </div>

    <div id="bansList" style="display:flex; flex-direction:column; gap:10px; max-height:62vh; overflow:auto; padding-top:8px;">
      <div class="profile-line skeleton" style="height:72px;"></div>
      <div class="profile-line skeleton" style="height:72px;"></div>
    </div>
    </div>

    <div id="settingsTab" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h3 style="margin:0 0 4px 0;">Admin Settings</h3>
        <div class="small">Danger zone - Critical operations</div>
      </div>
    </div>

    <div style="margin-top:20px; padding:16px; background: rgba(255,74,74,0.06); border: 1px solid rgba(255,74,74,0.12); border-radius:12px;">
      <h4 style="margin-bottom:8px; color:var(--danger);">Danger Zone</h4>
      <div class="small" style="margin-bottom:12px;">These actions cannot be undone. Please proceed with caution.</div>
      
      <div style="display:flex; flex-direction:column; gap:8px;">
        <button id="downloadData" class="btn btn-ghost"><i class="fa-solid fa-download"></i> Export CSV</button>
        <button id="purgeProfiles" class="btn btn-danger"><i class="fa-solid fa-user-slash"></i> Purge demo profiles</button>
      </div>
    </div>
    </div>
  </div>

  <div class="panel side">
    <div>
      <h3 style="margin:0 0 4px 0;">Quick Stats</h3>
      <div class="small">System overview</div>
    </div>
    
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px; font-size:13px;">
      <div style="padding:10px; background:rgba(255,255,255,0.02); border-radius:8px;">
        <div style="color:var(--muted);">Games</div>
        <div id="statGames" style="font-weight:600; font-size:18px;">—</div>
      </div>
      <div style="padding:10px; background:rgba(255,255,255,0.02); border-radius:8px;">
        <div style="color:var(--muted);">Profiles</div>
        <div id="statProfiles" style="font-weight:600; font-size:18px;">—</div>
      </div>
      <div style="padding:10px; background:rgba(255,255,255,0.02); border-radius:8px;">
        <div style="color:var(--muted);">Admins</div>
        <div id="statAdmins" style="font-weight:600; font-size:18px;">—</div>
      </div>
      <div style="padding:10px; background:rgba(255,74,74,0.06); border-radius:8px; border:1px solid rgba(255,74,74,0.12);">
        <div style="color:var(--muted);">Bans</div>
        <div id="statBans" style="font-weight:600; font-size:18px; color:var(--danger);">—</div>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modalContent"></div>
</div>

<script type="module">

/* ===== BANS TABLE SQL SCHEMA =====
 * * Create the bans table in Supabase with the following SQL:
 * * CREATE TABLE public.bans (
 * id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
 * user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
 * username TEXT NOT NULL,
 * reason TEXT,
 * ban_type TEXT NOT NULL CHECK (ban_type IN ('permanent', 'temporary')),
 * banned_until TIMESTAMP WITH TIME ZONE,
 * is_appealable BOOLEAN DEFAULT false,
 * offensive_content TEXT,
 * moderator_note TEXT,
 * created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
 * created_by_admin TEXT NOT NULL
 * );
 * * CREATE INDEX idx_bans_user_id ON public.bans(user_id);
 * CREATE INDEX idx_bans_username ON public.bans(username);
 * * ===== END SCHEMA =====
 */

/* ===== ADMINS TABLE SQL SCHEMA (REFERENCE) =====
 * * If you haven't created the admins table yet, use this SQL:
 * * CREATE TABLE public.admins (
 * id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
 * email TEXT NOT NULL UNIQUE,
 * created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
 * );
 * * ===== END SCHEMA =====
 */

/* ===== SETUP INSTRUCTIONS =====
 * * 1. In Supabase, go to SQL Editor and run the above schema SQL
 * 2. Enable RLS (Row Level Security) on both tables if needed
 * 3. Add your admin email to the admins table
 * 4. Add banned users via the admin panel's Bans tab
 * * ===== END INSTRUCTIONS =====
 */

/* ----------------- helpers ----------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function showMsg(el, txt, soon=3500){
  el.textContent = txt;
  setTimeout(()=>{ if(el.textContent === txt) el.textContent = ''; }, soon);
}
function showModal(html){
  const mb = $('#modalBackdrop'), mc = $('#modalContent');
  mc.innerHTML = html;
  mb.style.display = 'flex';
  mb.setAttribute('aria-hidden','false');
}
function hideModal(){
  const mb = $('#modalBackdrop');
  mb.style.display = 'none';
  mb.setAttribute('aria-hidden','true');
}
function confirmDialog(title, body){ // returns Promise<boolean>
  return new Promise(res => {
    showModal(`<h3>${title}</h3><div class="small" style="margin-bottom:12px;">${body}</div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="cNo" class="btn btn-ghost">Cancel</button>
        <button id="cYes" class="btn btn-danger">Confirm</button>
      </div>`);
    $('#cNo').onclick = ()=>{ hideModal(); res(false); };
    $('#cYes').onclick = ()=>{ hideModal(); res(true); };
  });
}

/* -------------- main state & UI -------------- */
const gamesListEl = $('#gamesList');
const profilesListEl = $('#profilesList');
const addGameBtn = $('#addGameBtn');
const refreshGamesBtn = $('#refreshGames');
const refreshProfilesBtn = $('#refreshProfiles');
const purgeProfilesBtn = $('#purgeProfiles');
const downloadDataBtn = $('#downloadData');
const gameFormMsg = $('#gameFormMsg');

const bansListEl = $('#bansList');
const banMsg = $('#banMsg');
const searchUserBtn = $('#searchUserBtn');
const banSearchUsername = $('#banSearchUsername');
const searchResult = $('#searchResult');
const refreshBansBtn = $('#refreshBans');

let cachedGames = [];
let cachedProfiles = [];
let cachedAdmins = [];
let cachedBans = [];
let currentUserEmail = null;
let selectedUserForBan = null;

/* --------------- AI API helper --------------- */
async function callAI(message) {
  try {
    const response = await fetch('https://apifreellm.com/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ message }),
      mode: 'cors'
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('[AI] Response:', data);
    
    if (data.status === 'success' && data.response) {
      return data.response;
    } else {
      throw new Error(data.error || data.message || 'AI API error');
    }
  } catch (err) {
    console.error('[AI] Error:', err);
    throw err;
  }
}

async function generateGameDescription(gameName) {
  try {
    const response = await callAI(`give me a short 3 sentence description for the game "${gameName}" no explanation, no questions. only the description.`);
    return response;
  } catch (err) {
    showMsg(gameFormMsg, 'Failed to generate description: ' + err.message);
    return '';
  }
}

async function generateGameTags(gameName) {
  try {
    const response = await callAI(`give me 25, comma separated tags for the game "${gameName}" no explanation, no questions. only the tags.`);
    return response;
  } catch (err) {
    showMsg(gameFormMsg, 'Failed to generate tags: ' + err.message);
    return '';
  }
}

/* --------------- Image Compression and Upload Handler --------------- */

let uploadedImageDataUrl = null;

// Image compression and upload handler
function compressImage(file, maxWidth = 500, maxHeight = 500, quality = 0.8) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Calculate new dimensions
        if (width > height) {
          if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width *= maxHeight / height;
            height = maxHeight;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convert to data URL with compression
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('gameImgUpload');
  const preview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) {
      uploadedImageDataUrl = null;
      preview.style.display = 'none';
      return;
    }
    
    try {
      showMsg(gameFormMsg, 'Compressing image...');
      uploadedImageDataUrl = await compressImage(file, 500, 500, 0.8);
      previewImg.src = uploadedImageDataUrl;
      preview.style.display = 'block';
      showMsg(gameFormMsg, 'Image ready');
    } catch (err) {
      showMsg(gameFormMsg, 'Image compression failed: ' + err.message);
      uploadedImageDataUrl = null;
      preview.style.display = 'none';
    }
  });
});

/**
 * Minifies HTML content by removing all unnecessary whitespace.
 * @param {string} htmlString - The HTML content to compress.
 * @returns {string} The compressed HTML string.
 */
function compressHtmlContent(htmlString) {
 if (!htmlString) return '';
 // Remove multi-line comments (C-style block comments)
 let compressed = htmlString.replace(/\/\*[\s\S]*?\*\//g, '');
 // Collapse whitespace between tags (optional but good practice)
 compressed = compressed.replace(/>\s+</g, '><');
 // Remove all leading/trailing whitespace and collapse internal whitespace to a single space
 compressed = compressed.replace(/\s\s+/g, ' ').trim();
 // Remove whitespace around specific characters (>, <, =, ;)
 compressed = compressed.replace(/\s*([<>={};])\s*/g, '$1');
 return compressed;
}

/* --------------- auth guard & admin check --------------- */
async function requireSignIn(){
  const client = window.supabaseClient;
  if (!client) throw new Error('Supabase client not available');
  
  const { data: { session } } = await client.auth.getSession();
  if (!session) {
    // Show modal forcing sign-in
    showModal(`<h3>Admin access required</h3>
      <div class="small" style="margin-bottom:12px;">You must be signed in to access the admin panel. <br><br>
      <button id="toLogin" class="btn btn-primary"><i class="fa-solid fa-right-to-bracket"></i> Sign in</button></div>`);
    $('#toLogin').onclick = ()=> {
      hideModal();
      window.location.href = '/auth';
    };
    throw new Error('not-signed-in');
  }
  
  currentUserEmail = session.user.email;
  
  // Check if user is in admins table
  const { data: adminRecord, error: adminError } = await client.from('admins').select('id').eq('email', currentUserEmail).single();
  
  if (adminError || !adminRecord) {
    showModal(`<h3>Admin access denied</h3>
      <div class="small" style="margin-bottom:12px;">Your account (${currentUserEmail}) does not have admin privileges.</div>
      <div style="text-align:right;"><button id="closeModal" class="btn btn-primary">OK</button></div>`);
    $('#closeModal').onclick = ()=> {
      hideModal();
      window.location.href = '/';
    };
    throw new Error('not-admin');
  }
  
  return session.user;
}

/* --------------- games CRUD ----------------- */

async function loadGames(){
  gamesListEl.innerHTML = '';
  // show skeletons
  for (let i=0;i<3;i++){
    const s = document.createElement('div');
    s.className = 'card skeleton';
    s.style.height = '96px';
    gamesListEl.appendChild(s);
  }

  const { data, error } = await window.supabaseClient.from('games').select('*').order('id', { ascending: false });
  if (error) {
    gamesListEl.innerHTML = `<div class="small">Failed to load games: ${error.message}</div>`;
    return;
  }
  cachedGames = data || [];
  renderGames();
}

function renderGames(){
  gamesListEl.innerHTML = '';
  if (!cachedGames.length) {
    gamesListEl.innerHTML = `<div class="small">No games yet</div>`;
    return;
  }

  cachedGames.forEach(game => {
    const card = document.createElement('div'); card.className = 'card';
    const thumb = document.createElement('div'); thumb.className = 'game-thumb';
    const img = document.createElement('img'); img.src = game.img_url || `https://placehold.co/500x500/000/fff?text=${(game.name||'G')[0].toUpperCase()}`;
    thumb.appendChild(img);

    const body = document.createElement('div'); body.className = 'card-body';
    const row = document.createElement('div'); row.className = 'row';
    const title = document.createElement('div'); title.className = 'title'; title.textContent = game.name || 'Untitled';
    const btns = document.createElement('div'); btns.className = 'flex';

    const editBtn = document.createElement('button'); editBtn.className = 'btn btn-ghost'; editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
    editBtn.onclick = ()=> openEditGame(game);
    const delBtn = document.createElement('button'); delBtn.className = 'btn btn-danger'; delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
    delBtn.onclick = async ()=> {
      const ok = await confirmDialog('Delete game', `Delete "${game.name}"? This cannot be undone.`);
      if (!ok) return;
      const { error } = await window.supabaseClient.from('games').delete().eq('id', game.id);
      if (error) return showMsg(gameFormMsg, 'Delete failed: ' + error.message);
      cachedGames = cachedGames.filter(g=>g.id !== game.id);
      renderGames();
      showMsg(gameFormMsg, 'Deleted.');
    };

    // plays and favorites chips
    const chips = document.createElement('div'); chips.className = 'chips';
    const playsChip = document.createElement('div'); playsChip.className = 'chip'; playsChip.innerHTML = `<i class="fa-solid fa-play"></i> ${game.plays||0}`;
    const favChip = document.createElement('div'); favChip.className = 'chip'; favChip.innerHTML = `<i class="fa-solid fa-heart"></i> ${game.favorites||0}`;
    chips.appendChild(playsChip); chips.appendChild(favChip);

    // description line
    const desc = document.createElement('div'); desc.className = 'small muted';
    const txt = (game.description||'').trim();
    desc.textContent = txt.length > 160 ? txt.slice(0,160) + '...' : txt;

    btns.append(editBtn, delBtn);
    row.append(title, btns);
    body.append(row, chips, desc);

    card.append(thumb, body);
    gamesListEl.appendChild(card);
  });
}

async function addGame(){
  const name = $('#gameName').value.trim();
  const externalUrl = $('#gameExternalUrl').value.trim();
  const htmlRaw = $('#gameHtmlContent').value.trim(); // Raw HTML
  const tagsRaw = $('#gameTags').value.trim();
  const desc = $('#gameDesc').value.trim(); // This is hidden, but keep for completeness

  if (!name || (!externalUrl && !htmlRaw) || !uploadedImageDataUrl) {
    return showMsg(gameFormMsg, 'Name, image, and EITHER URL or HTML required');
  }

  const compressedHtml = compressHtmlContent(htmlRaw); // Minify HTML
  
  const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];

  addGameBtn.disabled = true;
  addGameBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';

  const payload = { 
    name, 
    description: desc, 
    tags, 
    img_url: uploadedImageDataUrl, 
    url: externalUrl || null, // Use URL only if no HTML is provided (or if HTML is empty)
    html: compressedHtml || null, // Use compressed HTML
    plays: 0, 
    favorites: 0 
  };
  
  // Important logic check: If HTML is provided, the primary URL should be null.
  if (payload.html) {
      payload.url = null;
  } else if (!payload.url) {
      // If neither HTML nor URL, something is wrong, but the initial check should catch this
      return showMsg(gameFormMsg, 'Name, image, and EITHER URL or HTML required');
  }


  const { data, error } = await window.supabaseClient.from('games').insert([payload]).select().single();

  addGameBtn.disabled = false;
  addGameBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Game';

  if (error) {
    return showMsg(gameFormMsg, 'Add failed: ' + error.message);
  }
  
  // reset form
  $('#gameName').value = '';
  $('#gameExternalUrl').value = '';
  $('#gameHtmlContent').value = '';
  $('#gameTags').value = '';
  $('#gameDesc').value = '';
  uploadedImageDataUrl = null;
  document.getElementById('gameImgUpload').value = ''; // Reset file input
  document.getElementById('imagePreview').style.display = 'none';
  cachedGames.unshift(data);
  renderGames();
  showMsg(gameFormMsg, 'Game added');
}
function openEditGame(game){
  const tagsString = Array.isArray(game.tags) ? game.tags.join(',') : (game.tags || '');
  showModal(`<h3>Edit Game</h3>
    <div class="field"><label>Name</label><input id="e_name" value="${escapeHtml(game.name||'')}" /></div>
    <div class="field"><label>Image URL</label><input id="e_img" value="${escapeHtml(game.img_url||'')}" /></div>
    <div class="field"><label>Game URL (External)</label><input id="e_url" value="${escapeHtml(game.url||'')}" /></div>
    <div class="field"><label>HTML Content (Compressed)</label><textarea id="e_html">${escapeHtml(game.html||'')}</textarea></div>
    <div class="field"><label>Tags (comma separated)</label><input id="e_tags" value="${escapeHtml(tagsString)}" /></div>
    <div class="field"><label style="display:none;">Description</label><textarea id="e_desc" style="display:none;">${escapeHtml(game.description||'')}</textarea></div>
    <div style="display:flex;gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="egCancel" class="btn btn-ghost">Cancel</button>
      <button id="egSave" class="btn btn-primary">Save</button>
    </div>`);

  $('#egCancel').onclick = hideModal;
  $('#egSave').onclick = async ()=>{
    const name = $('#e_name').value.trim();
    const img = $('#e_img').value.trim();
    let url = $('#e_url').value.trim();
    const htmlRaw = $('#e_html').value.trim();
    const tags = ($('#e_tags').value || '').split(',').map(t=>t.trim()).filter(Boolean);
    const desc = $('#e_desc').value.trim();
    
    // Compress HTML on edit, and clear URL if HTML is present
    const compressedHtml = compressHtmlContent(htmlRaw);
    if (compressedHtml) {
        url = null;
    }

    const { error, data } = await window.supabaseClient.from('games').update({
      name, 
      img_url: img, 
      url: url, 
      html: compressedHtml, // Save the compressed HTML
      tags, 
      description: desc
    }).eq('id', game.id).select().single();

    if (error) { showModal(`<h3>Error</h3><div class="small">${error.message}</div><div style="text-align:right;margin-top:8px;"><button id="errOk" class="btn btn-primary">OK</button></div>`); $('#errOk').onclick = hideModal; return; }

    // update local cache and UI
    const idx = cachedGames.findIndex(g=>g.id===game.id);
    if (idx !== -1) cachedGames[idx] = data;
    renderGames();
    hideModal();
    showMsg(gameFormMsg, 'Saved.');
  };
}

/* ------------- profiles management -------------- */

async function loadProfiles(){
  profilesListEl.innerHTML = '';
  // skeletons
  for (let i=0;i<3;i++){
    const s = document.createElement('div'); s.className = 'profile-line skeleton'; s.style.height='72px';
    profilesListEl.appendChild(s);
  }

  const { data, error } = await window.supabaseClient.from('profiles').select('*').order('created_at', { ascending: false }).limit(200);
  if (error) {
    profilesListEl.innerHTML = `<div class="small">Failed to load profiles: ${error.message}</div>`;
    return;
  }
  cachedProfiles = data || [];
  renderProfiles();
}

function renderProfiles(){
  profilesListEl.innerHTML = '';
  if (!cachedProfiles.length) {
    profilesListEl.innerHTML = `<div class="small">No profiles found</div>`;
    return;
  }

  cachedProfiles.forEach(p=>{
    const line = document.createElement('div'); line.className = 'profile-line';
    const left = document.createElement('div'); left.className = 'pf-left';
    const thumb = document.createElement('div'); thumb.className = 'pf-thumb';
    const img = document.createElement('img'); img.src = p.avatar_url || `https://placehold.co/100x100/000/fff?text=${(p.username||'U').charAt(0).toUpperCase()}`;
    thumb.appendChild(img);
    const meta = document.createElement('div'); meta.className = 'pf-meta';
    const name = document.createElement('div'); name.className = 'name'; name.textContent = p.username || 'User';
    const email = document.createElement('div'); email.className = 'email'; email.textContent = p.email || '';
    meta.append(name, email);
    left.append(thumb, meta);

    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
    const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
    editBtn.onclick = ()=> openEditProfile(p);
    const resetPicBtn = document.createElement('button'); resetPicBtn.className='btn btn-ghost'; resetPicBtn.innerHTML = '<i class="fa-solid fa-image"></i>';
    resetPicBtn.title = 'Reset profile picture';
    resetPicBtn.onclick = async ()=>{
      const ok = await confirmDialog('Reset picture', `Reset profile picture for ${p.username || p.email}?`);
      if(!ok) return;
      const defaultAvatar = `https://placehold.co/500x500/000/fff?text=${(p.username||'U')[0].toUpperCase()}`;
      const { error } = await window.supabaseClient.from('profiles').update({ avatar_url: defaultAvatar }).eq('id', p.id);
      if (error) return showMsg(profilesListEl, 'Reset failed: ' + error.message);
      // update local
      const idx = cachedProfiles.findIndex(pp=>pp.id===p.id);
      if (idx !== -1) cachedProfiles[idx].avatar_url = defaultAvatar;
      renderProfiles();
      showMsg(profilesListEl, 'Profile picture reset');
    };

    const resetAllBtn = document.createElement('button'); resetAllBtn.className='btn btn-danger'; resetAllBtn.innerHTML = '<i class="fa-solid fa-rotate-left"></i>';
    resetAllBtn.title = 'Reset username & bio & picture';
    resetAllBtn.onclick = async ()=>{
      const ok = await confirmDialog('Reset profile', `Reset username, bio and picture for ${p.username || p.email}?`);
      if(!ok) return;
      const defaultAvatar = `https://placehold.co/500x500/000/fff?text=${(p.username||'U')[0].toUpperCase()}`;
      const { error } = await window.supabaseClient.from('profiles').update({ username: 'User', bio: '', avatar_url: defaultAvatar }).eq('id', p.id);
      if (error) return showMsg(profilesListEl, 'Reset failed: ' + error.message);
      const idx = cachedProfiles.findIndex(pp=>pp.id===p.id);
      if (idx !== -1) cachedProfiles[idx] = { ...cachedProfiles[idx], username: 'User', bio: '', avatar_url: defaultAvatar };
      renderProfiles();
      showMsg(profilesListEl, 'Profile reset');
    };

    right.append(editBtn, resetPicBtn, resetAllBtn);
    line.append(left, right);
    profilesListEl.appendChild(line);
  });
}

function openEditProfile(profile){
  showModal(`<h3>Edit Profile — ${escapeHtml(profile.email || profile.id)}</h3>
    <div class="field"><label>Username</label><input id="p_username" value="${escapeHtml(profile.username||'')}" /></div>
    <div class="field"><label>Bio</label><textarea id="p_bio">${escapeHtml(profile.bio||'')}</textarea></div>
    <div class="field"><label>Avatar URL</label><input id="p_avatar" value="${escapeHtml(profile.avatar_url||'')}" /></div>
    <div style="display:flex;gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="pCancel" class="btn btn-ghost">Cancel</button>
      <button id="pSave" class="btn btn-primary">Save</button>
    </div>`);

  $('#pCancel').onclick = hideModal;
  $('#pSave').onclick = async ()=>{
    const username = $('#p_username').value.trim() || 'User';
    const bio = $('#p_bio').value.trim() || '';
    const avatar = $('#p_avatar').value.trim() || `https://placehold.co/500x500/000/fff?text=${username[0].toUpperCase()}`;
    const { error } = await window.supabaseClient.from('profiles').update({ username, bio, avatar_url: avatar }).eq('id', profile.id);
    if (error) {
      showModal(`<h3>Error</h3><div class="small">${error.message}</div><div style="text-align:right;margin-top:8px;"><button id="errOk" class="btn btn-primary">OK</button></div>`);
      $('#errOk').onclick = hideModal;
      return;
    }
    // update cache and UI
    const idx = cachedProfiles.findIndex(p=>p.id===profile.id);
    if (idx !== -1) cachedProfiles[idx] = { ...cachedProfiles[idx], username, bio, avatar_url: avatar };
    renderProfiles();
    hideModal();
    showMsg(profilesListEl, 'Saved.');
  };
}

/* --------------- admin actions --------------- */

downloadDataBtn.onclick = async ()=>{
  // export profiles and games as CSV
  const { data: games } = await window.supabaseClient.from('games').select('*');
  const { data: profiles } = await window.supabaseClient.from('profiles').select('*');
  const csv = toCsv({ games, profiles });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'moonlight_export.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

purgeProfilesBtn.onclick = async ()=>{
  const ok = await confirmDialog('Purge demo profiles', 'This will delete profiles that match a demo/test pattern. Are you sure?');
  if (!ok) return;
  // Example: delete profiles with email ending with @example.com (customize as needed)
  const { error } = await window.supabaseClient.from('profiles').delete().ilike('email', '%@example.com');
  if (error) return showMsg(profilesListEl, 'Purge failed: ' + error.message);
  await loadProfiles();
  showMsg(profilesListEl, 'Purge complete');
};

/* --------------- helpers & utils --------------- */
function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toCsv({ games=[], profiles=[] }){
  const lines = [];
  lines.push('---GAMES---');
  if (games.length){
    const keys = Object.keys(games[0]);
    lines.push(keys.join(','));
    games.forEach(g => lines.push(keys.map(k => JSON.stringify(g[k] ?? '')).join(',')));
  } else lines.push('no games');

  lines.push('');
  lines.push('---PROFILES---');
  if (profiles.length){
    const keys = Object.keys(profiles[0]);
    lines.push(keys.join(','));
    profiles.forEach(g => lines.push(keys.map(k => JSON.stringify(g[k] ?? '')).join(',')));
  } else lines.push('no profiles');

  return lines.join('\n');
}

/* --------------- events --------------- */
addGameBtn.onclick = addGame;
refreshGamesBtn.onclick = loadGames;
refreshProfilesBtn.onclick = loadProfiles;

// AI buttons
document.getElementById('generateDescBtn').onclick = async ()=> {
  const gameName = $('#gameName').value.trim();
  if (!gameName) return showMsg(gameFormMsg, 'Enter game name first');
  
  const btn = document.getElementById('generateDescBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
  
  try {
    const desc = await generateGameDescription(gameName);
    $('#gameDesc').value = desc.trim();
    showMsg(gameFormMsg, 'Description generated');
  } catch (err) {
    showMsg(gameFormMsg, 'Generation failed: ' + err.message);
  }
  
  btn.disabled = false;
  btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Fill';
};

document.getElementById('generateTagsBtn').onclick = async ()=> {
  const gameName = $('#gameName').value.trim();
  if (!gameName) return showMsg(gameFormMsg, 'Enter game name first');
  
  const btn = document.getElementById('generateTagsBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
  
  try {
    const tags = await generateGameTags(gameName);
    $('#gameTags').value = tags.trim();
    showMsg(gameFormMsg, 'Tags generated');
  } catch (err) {
    showMsg(gameFormMsg, 'Generation failed: ' + err.message);
  }
  
  btn.disabled = false;
  btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Tags';
};

// Tab navigation
document.getElementById('tabGames').onclick = ()=> switchTab('games');
document.getElementById('tabProfiles').onclick = ()=> switchTab('profiles');
document.getElementById('tabAdmins').onclick = ()=> switchTab('admins');
document.getElementById('tabBans').onclick = ()=> switchTab('bans');
document.getElementById('tabSettings').onclick = ()=> switchTab('settings');

function switchTab(tabName) {
  // Hide all tabs
  document.getElementById('gamesTab').classList.remove('active');
  document.getElementById('profilesTab').classList.remove('active');
  document.getElementById('adminsTab').classList.remove('active');
  document.getElementById('bansTab').classList.remove('active');
  document.getElementById('settingsTab').classList.remove('active');
  
  // Remove active from all buttons
  document.getElementById('tabGames').classList.remove('active');
  document.getElementById('tabProfiles').classList.remove('active');
  document.getElementById('tabAdmins').classList.remove('active');
  document.getElementById('tabBans').classList.remove('active');
  document.getElementById('tabSettings').classList.remove('active');
  
  // Show selected tab and button
  let tabId, btnId;
  if (tabName === 'games') { tabId = 'gamesTab'; btnId = 'tabGames'; }
  else if (tabName === 'profiles') { tabId = 'profilesTab'; btnId = 'tabProfiles'; }
  else if (tabName === 'admins') { tabId = 'adminsTab'; btnId = 'tabAdmins'; }
  else if (tabName === 'bans') { tabId = 'bansTab'; btnId = 'tabBans'; }
  else if (tabName === 'settings') { tabId = 'settingsTab'; btnId = 'tabSettings'; }
  
  document.getElementById(tabId).classList.add('active');
  document.getElementById(btnId).classList.add('active');
}

// Admin management
const adminMsg = document.getElementById('adminMsg');
const addAdminBtn = document.getElementById('addAdminBtn');
const adminEmailInput = document.getElementById('adminEmailInput');
const adminsList = document.getElementById('adminsList');

async function loadAdmins(){
  adminsList.innerHTML = '';
  for (let i=0;i<3;i++){
    const s = document.createElement('div'); s.className = 'profile-line skeleton'; s.style.height='72px';
    adminsList.appendChild(s);
  }
  
  const { data, error } = await window.supabaseClient.from('admins').select('*').order('created_at', { ascending: false });
  if (error) {
    adminsList.innerHTML = `<div class="small">Failed to load admins: ${error.message}</div>`;
    return;
  }
  cachedAdmins = data || [];
  renderAdmins();
}

function renderAdmins(){
  adminsList.innerHTML = '';
  if (!cachedAdmins.length) {
    adminsList.innerHTML = `<div class="small">No admins yet</div>`;
    return;
  }
  
  cachedAdmins.forEach(admin => {
    const line = document.createElement('div'); line.className = 'profile-line';
    const left = document.createElement('div'); left.className = 'pf-left';
    const thumb = document.createElement('div'); thumb.className = 'pf-thumb';
    const img = document.createElement('img'); img.src = `https://placehold.co/100x100/000/fff?text=${admin.email.charAt(0).toUpperCase()}`;
    thumb.appendChild(img);
    const meta = document.createElement('div'); meta.className = 'pf-meta';
    const name = document.createElement('div'); name.className = 'name'; name.textContent = admin.email;
    const date = document.createElement('div'); date.className = 'email'; date.textContent = new Date(admin.created_at).toLocaleDateString();
    meta.append(name, date);
    left.append(thumb, meta);
    
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
    const delBtn = document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
    delBtn.onclick = async ()=>{
      const ok = await confirmDialog('Remove admin', `Remove ${admin.email} from admins?`);
      if(!ok) return;
      const { error } = await window.supabaseClient.from('admins').delete().eq('id', admin.id);
      if (error) return showMsg(adminMsg, 'Remove failed: ' + error.message);
      cachedAdmins = cachedAdmins.filter(a=>a.id !== admin.id);
      renderAdmins();
      showMsg(adminMsg, 'Admin removed');
    };
    
    right.append(delBtn);
    line.append(left, right);
    adminsList.appendChild(line);
  });
}

addAdminBtn.onclick = async ()=> {
  const email = adminEmailInput.value.trim().toLowerCase();
  if (!email) return showMsg(adminMsg, 'Enter an email');
  
  // Check if already admin
  if (cachedAdmins.some(a=>a.email === email)) return showMsg(adminMsg, 'Already an admin');
  
  addAdminBtn.disabled = true;
  addAdminBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';
  
  const { error } = await window.supabaseClient.from('admins').insert([{ email }]);
  
  addAdminBtn.disabled = false;
  addAdminBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Admin';
  
  if (error) return showMsg(adminMsg, 'Add failed: ' + error.message);
  
  adminEmailInput.value = '';
  await loadAdmins();
  showMsg(adminMsg, 'Admin added');
};

document.getElementById('refreshAdmins').onclick = loadAdmins;

/* --------------- ban management --------------- */

async function loadBans(){
  bansListEl.innerHTML = '';
  for (let i=0;i<3;i++){
    const s = document.createElement('div'); s.className = 'profile-line skeleton'; s.style.height='72px';
    bansListEl.appendChild(s);
  }
  
  const { data, error } = await window.supabaseClient.from('bans').select('*').order('created_at', { ascending: false });
  if (error) {
    bansListEl.innerHTML = `<div class="small">Failed to load bans: ${error.message}</div>`;
    return;
  }
  cachedBans = data || [];
  renderBans();
}

function renderBans(){
  bansListEl.innerHTML = '';
  if (!cachedBans.length) {
    bansListEl.innerHTML = `<div class="small">No active bans</div>`;
    return;
  }
  
  cachedBans.forEach(ban => {
    const line = document.createElement('div'); line.className = 'profile-line';
    const left = document.createElement('div'); left.className = 'pf-left';
    const thumb = document.createElement('div'); thumb.className = 'pf-thumb';
    const img = document.createElement('img'); img.src = `https://placehold.co/100x100/000/fff?text=${ban.username.charAt(0).toUpperCase()}`;
    thumb.appendChild(img);
    const meta = document.createElement('div'); meta.className = 'pf-meta';
    const name = document.createElement('div'); name.className = 'name'; name.textContent = ban.username;
    const info = document.createElement('div'); info.className = 'email';
    
    let banType = 'Permanent';
    if (ban.ban_type === 'temporary' && ban.banned_until) {
      const date = new Date(ban.banned_until);
      const now = new Date();
      const daysLeft = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
      banType = daysLeft > 0 ? `${daysLeft}d left` : 'Expired';
    }
    
    info.textContent = `${banType} • ${ban.reason || 'No reason'}`;
    meta.append(name, info);
    left.append(thumb, meta);
    
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
    const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
    editBtn.onclick = ()=> openEditBan(ban);
    const delBtn = document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
    delBtn.onclick = async ()=>{
      const ok = await confirmDialog('Remove ban', `Remove ban for ${ban.username}?`);
      if(!ok) return;
      const { error } = await window.supabaseClient.from('bans').delete().eq('id', ban.id);
      if (error) return showMsg(banMsg, 'Remove failed: ' + error.message);
      cachedBans = cachedBans.filter(b=>b.id !== ban.id);
      renderBans();
      updateStats();
      showMsg(banMsg, 'Ban removed');
    };
    
    right.append(editBtn, delBtn);
    line.append(left, right);
    bansListEl.appendChild(line);
  });
}

async function searchUserByUsername(){
  const username = banSearchUsername.value.trim().toLowerCase();
  if (!username) return showMsg(searchResult, 'Enter a username');
  
  searchUserBtn.disabled = true;
  searchUserBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
  
  const { data, error } = await window.supabaseClient.from('profiles').select('id, username').ilike('username', `%${username}%`).limit(5);
  
  searchUserBtn.disabled = false;
  searchUserBtn.innerHTML = '<i class="fa-solid fa-search"></i>';
  
  if (error) return showMsg(searchResult, 'Search failed: ' + error.message);
  
  const createBanBtn = document.getElementById('createBanBtn');
  
  if (!data || !data.length) {
    searchResult.innerHTML = '<span style="color:var(--danger);">No users found</span>';
    selectedUserForBan = null;
    createBanBtn.style.display = 'none';
    return;
  }
  
  if (data.length === 1) {
    selectedUserForBan = data[0];
    searchResult.innerHTML = `<span style="color:var(--ok);">✓ Found: ${data[0].username}</span>`;
    createBanBtn.style.display = 'inline-flex';
  } else {
    // Multiple results - show dropdown
    let html = '<select id="userSelect" style="padding:6px; border-radius:6px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); color:#fff; cursor:pointer;">';
    data.forEach(u => html += `<option value="${u.id}" data-username="${u.username}">${u.username}</option>`);
    html += '</select>';
    searchResult.innerHTML = html;
    $('#userSelect').onchange = (e)=> {
      const selected = data.find(u=>u.id === e.target.value);
      selectedUserForBan = selected;
    };
    selectedUserForBan = data[0];
    createBanBtn.style.display = 'inline-flex';
  }
}

function openCreateBanModal(){
  if (!selectedUserForBan) return showMsg(searchResult, 'Please select a user first');
  
  showModal(`<h3>Create Ban for ${escapeHtml(selectedUserForBan.username)}</h3>
    <div class="field"><label>Reason for ban</label><input id="b_reason" type="text" placeholder="e.g., Harassment, Spam" value="Harassment" /></div>
    <div class="field"><label>Ban Type</label><select id="b_type" style="width:100%;">
      <option value="permanent">Permanent</option>
      <option value="temporary">Temporary</option>
    </select></div>
    <div class="field"><label>Ban Until (if temporary)</label><input id="b_until" type="datetime-local" /></div>
    <div class="field"><label>Offensive Content (comma-separated)</label><input id="b_offensive" type="text" placeholder="e.g., harassment, hate speech" /></div>
    <div class="field"><label>Moderator Note</label><textarea id="b_moderator_note" placeholder="Internal notes about this ban..."></textarea></div>
    <div class="field"><label><input id="b_appeal" type="checkbox" style="width:auto; margin-right:6px;">Is Appealable</label></div>
    <div style="display:flex;gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="bCancel" class="btn btn-ghost">Cancel</button>
      <button id="bCreate" class="btn btn-danger">Create Ban</button>
    </div>`);

  $('#bCancel').onclick = hideModal;
  $('#bCreate').onclick = async ()=>{
    const reason = $('#b_reason').value.trim();
    const type = $('#b_type').value;
    const bannedUntil = $('#b_until').value ? new Date($('#b_until').value).toISOString() : null;
    const offensive = $('#b_offensive').value.trim();
    const moderatorNote = $('#b_moderator_note').value.trim();
    const appealable = $('#b_appeal').checked;
    
    const { error } = await window.supabaseClient.from('bans').insert([{
      user_id: selectedUserForBan.id,
      username: selectedUserForBan.username,
      reason,
      ban_type: type,
      banned_until: type === 'temporary' ? bannedUntil : null,
      is_appealable: appealable,
      offensive_content: offensive,
      moderator_note: moderatorNote,
      created_by_admin: currentUserEmail
    }]);
    
    if (error) {
      showModal(`<h3>Error</h3><div class="small">${error.message}</div><div style="text-align:right;margin-top:8px;"><button id="errOk" class="btn btn-primary">OK</button></div>`);
      $('#errOk').onclick = hideModal;
      return;
    }
    
    hideModal();
    banSearchUsername.value = '';
    searchResult.innerHTML = '';
    selectedUserForBan = null;
    await loadBans();
    updateStats();
    showMsg(banMsg, 'Ban created');
  };
}

function openEditBan(ban){
  const bannedUntilFormatted = ban.banned_until ? new Date(ban.banned_until).toISOString().slice(0, 16) : '';
  
  showModal(`<h3>Edit Ban — ${escapeHtml(ban.username)}</h3>
    <div class="field"><label>Reason</label><input id="b_reason" type="text" value="${escapeHtml(ban.reason||'')}" /></div>
    <div class="field"><label>Ban Type</label><select id="b_type">
      <option value="permanent" ${ban.ban_type === 'permanent' ? 'selected' : ''}>Permanent</option>
      <option value="temporary" ${ban.ban_type === 'temporary' ? 'selected' : ''}>Temporary</option>
    </select></div>
    <div class="field"><label>Ban Until (if temporary)</label><input id="b_until" type="datetime-local" value="${bannedUntilFormatted}" /></div>
    <div class="field"><label>Offensive Content (comma-separated)</label><input id="b_offensive" type="text" value="${escapeHtml(ban.offensive_content||'')}" /></div>
    <div class="field"><label>Moderator Note</label><textarea id="b_moderator_note">${escapeHtml(ban.moderator_note||'')}</textarea></div>
    <div class="field"><label><input id="b_appeal" type="checkbox" ${ban.is_appealable ? 'checked' : ''} style="width:auto; margin-right:6px;">Is Appealable</label></div>
    <div style="display:flex;gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="bCancel" class="btn btn-ghost">Cancel</button>
      <button id="bSave" class="btn btn-primary">Save</button>
    </div>`);

  $('#bCancel').onclick = hideModal;
  $('#bSave').onclick = async ()=>{
    const reason = $('#b_reason').value.trim();
    const type = $('#b_type').value;
    const bannedUntil = $('#b_until').value ? new Date($('#b_until').value).toISOString() : null;
    const offensive = $('#b_offensive').value.trim();
    const moderatorNote = $('#b_moderator_note').value.trim();
    const appealable = $('#b_appeal').checked;
    
    const { error } = await window.supabaseClient.from('bans').update({
      reason,
      ban_type: type,
      banned_until: type === 'temporary' ? bannedUntil : null,
      is_appealable: appealable,
      offensive_content: offensive,
      moderator_note: moderatorNote
    }).eq('id', ban.id);
    
    if (error) {
      showModal(`<h3>Error</h3><div class="small">${error.message}</div><div style="text-align:right;margin-top:8px;"><button id="errOk" class="btn btn-primary">OK</button></div>`);
      $('#errOk').onclick = hideModal;
      return;
    }
    
    hideModal();
    await loadBans();
    showMsg(banMsg, 'Ban updated');
  };
}

searchUserBtn.onclick = searchUserByUsername;
refreshBansBtn.onclick = loadBans;
document.getElementById('createBanBtn').onclick = openCreateBanModal;

// Create ban when selecting user
banSearchUsername.onkeydown = (e) => {
  if (e.key === 'Enter') searchUserByUsername();
};

/* --------------- stats update --------------- */
function updateStats(){
  const statGames = document.getElementById('statGames');
  const statProfiles = document.getElementById('statProfiles');
  const statAdmins = document.getElementById('statAdmins');
  const statBans = document.getElementById('statBans');
  
  statGames.textContent = cachedGames.length;
  statProfiles.textContent = cachedProfiles.length;
  statAdmins.textContent = cachedAdmins.length;
  statBans.textContent = cachedBans.length;
}

/* -------------- boot -------------- */
(async function init(){
  try {
    // Wait for Supabase client to be ready
    await new Promise(resolve => {
      if (window.supabaseClient) {
        // Already loaded
        resolve();
      } else {
        // Wait for supabase-ready event from chip.js
        window.addEventListener('supabase-ready', resolve, { once: true });
      }
    });

    // require sign in (or show modal)
    await requireSignIn();

    // initial loads
    await Promise.all([loadGames(), loadProfiles(), loadAdmins(), loadBans()]);
    updateStats();
    // listen to realtime changes (optional)
    try {
      const gamesChannel = window.supabaseClient.channel('public:games')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'games' }, payload => {
          // re-fetch on changes
          loadGames().catch(console.error);
        }).subscribe();

      const profilesChannel = window.supabaseClient.channel('public:profiles')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, payload => {
          loadProfiles().catch(console.error);
        }).subscribe();

      const bansChannel = window.supabaseClient.channel('public:bans')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'bans' }, payload => {
          loadBans().catch(console.error);
        }).subscribe();
    } catch(e){
      console.warn('Realtime subscription failed (not critical)', e);
    }
  } catch(err){
    console.warn('Admin access not started:', err);
  }
})();

</script>

</body>
</html>